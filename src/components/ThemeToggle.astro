---
import IconSun from "./icons/IconSun.astro";
import IconMoon from "./icons/IconMoon.astro";
---

<button
  id="toggle-theme-btn"
  type="button"
  aria-label="Cambiar tema"
  aria-pressed="false"
  class="flex items-center justify-center gap-2 px-2 py-1 md:px-4 md:py-2 rounded-full border border-neutral-300 dark:border-neutral-600
         bg-[var(--btn-bg)] dark:bg-[var(--btn-bg-dark)]
         hover:bg-neutral-100 dark:hover:bg-neutral-700
         transition-colors duration-200
         focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-[var(--color-primary)]
         text-[var(--color-text)]"
>
  <div
    id="sun-icon"
    class="transition-opacity duration-300 opacity-0"
    aria-hidden="true"
  >
    <IconSun class="w-5 h-5 md:w-6 md:h-6 text-neutral-900" />
  </div>
  <div
    id="moon-icon"
    class="transition-opacity duration-300 opacity-0"
    aria-hidden="true"
  >
    <IconMoon class="w-5 h-5 md:w-6 md:h-6 text-neutral-400" />
  </div>
  <noscript><IconSun /></noscript>
</button>

<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    const root = document.documentElement;
    const btn = document.getElementById("toggle-theme-btn");
    const sunIcon = document.getElementById("sun-icon");
    const moonIcon = document.getElementById("moon-icon");
    const logo = document.getElementById("logo-img");
    const media = window.matchMedia("(prefers-color-scheme: dark)");

    const setUI = (isDark) => {
      sunIcon && (sunIcon.style.opacity = isDark ? "0" : "1");
      sunIcon && sunIcon.setAttribute("aria-hidden", String(isDark));
      moonIcon && (moonIcon.style.opacity = isDark ? "1" : "0");
      moonIcon && moonIcon.setAttribute("aria-hidden", String(!isDark));

      root.classList.toggle("dark", isDark);
      root.setAttribute("data-theme", isDark ? "dark" : "light");
      localStorage.setItem("theme", isDark ? "dark" : "light");

      if (btn) {
        btn.setAttribute("aria-pressed", String(isDark));
        btn.setAttribute(
          "aria-label",
          isDark ? "Cambiar a tema claro" : "Cambiar a tema oscuro"
        );
      }
      if (logo) {
        logo.src = isDark
          ? "/assets/img/logo/edits/iabot-09.webp"
          : "/assets/img/logo/edits/iabot-06.webp";
      }
    };

    const getInitialTheme = () => {
      const stored = localStorage.getItem("theme");
      if (stored === "dark" || stored === "light") return stored === "dark";
      return media.matches;
    };

    const init = () => {
      setUI(getInitialTheme());
      btn?.addEventListener("click", () =>
        setUI(!root.classList.contains("dark"))
      );
      // sincroniza si cambia el tema del sistema
      const onChange = (e) => {
        if (!localStorage.getItem("theme")) setUI(e.matches);
      };
      media.addEventListener?.("change", onChange);
      media.addListener?.(onChange);
    };

    requestAnimationFrame(init);
  });
</script>
